{"name":"Php-wechat","tagline":"personal wechat sdk repos.","body":"wechat-php-sdk\r\n==============\r\n###Thanks for [wechat-php-sdk](https://github.com/dodgepudding/wechat-php-sdk)\r\n\r\n使用详解\r\n-------\r\n使用前需先打开微信帐号的开发模式，详细步骤请查看微信公众平台接口使用说明：  \r\nhttp://mp.weixin.qq.com/wiki/\r\n\r\n微信支付接入文档：\r\nhttps://mp.weixin.qq.com/cgi-bin/readtemplate?t=business/course2_tmpl&lang=zh_CN\r\n\r\n1. wechat.class.php  \r\n调用官方API，具有更灵活的消息分类响应方式，支持链式调用操作 ； \r\n\r\n### 主要功能 \r\n- 接入验证 （初级权限）\r\n- 自动回复（文本、图片、语音、视频、音乐、图文）（初级权限）\r\n- 菜单操作（查询、创建、删除）（菜单权限）\r\n- 客服消息（文本、图片、语音、视频、音乐、图文）（认证权限）\r\n- 二维码（创建临时、永久二维码，获取二维码URL）（认证权限）\r\n- 分组操作（查询、创建、修改、移动用户到分组）（认证权限）\r\n- 网页授权（基本授权，用户信息授权）（认证权限）\r\n- 用户信息（查询用户基本信息、获取关注者列表）（认证权限）\r\n- 媒体文件（上传、获取）（认证权限） \r\n- 调用地址组件 （支付权限） \r\n- 生成订单签名数据 （支付权限） \r\n- 订单成功回调 （支付权限） \r\n- 发货通知 （支付权限） \r\n- 支付订单查询 （支付权限） \r\n\r\n\r\n### 初始化动作 \r\n```php\r\n $options = array(\r\n\t'token'=>'tokenaccesskey', //填写你设定的key\r\n\t'appid'=>'wxdk1234567890', //填写高级调用功能的app id, 请在微信开发模式后台查询\r\n\t'appsecret'=>'xxxxxxxxxxxxxxxxxxx', //填写高级调用功能的密钥\r\n\t'partnerid'=>'88888888', //财付通商户身份标识，支付权限专用，没有可不填\r\n\t'partnerkey'=>'', //财付通商户权限密钥Key，支付权限专用\r\n\t'paysignkey'=>'' //商户签名密钥Key，支付权限专用\r\n\t);\r\n $weObj = new Wechat($options); //创建实例对象\r\n //TODO：调用$weObj各实例方法\r\n\r\n```\r\n\r\n新增Auth高级权限类方法:   \r\n *  checkAuth($appid,$appsecret) 此处传入公众后台高级接口提供的appid和appsecret, 函数将返回access_token操作令牌\r\n *  createMenu($data) 创建菜单 $data菜单结构详见 http://mp.weixin.qq.com/wiki/index.php?title=%E8%87%AA%E5%AE%9A%E4%B9%89%E8%8F%9C%E5%8D%95%E5%88%9B%E5%BB%BA%E6%8E%A5%E5%8F%A3 \r\n *  getMenu() 获取菜单 \r\n *  deleteMenu() 删除菜单 \r\n *  getMedia() 获取接收到的音频、视频媒体文件 \r\n *  getQRCode($scene_id,$type=0,$expire=1800) 获取推广二维码ticket字串 \r\n *  getQRUrl($ticket) 获取二维码图片地址\r\n *  getUserList($next_openid) 批量获取关注用户列表 \r\n *  getUserInfo($openid) 获取关注者详细信息 \r\n *  getGroup() 获取用户分组列表 \r\n *  createGroup($name) 新增自定分组 \r\n *  updateGroup($groupid,$name) 更改分组名称 \r\n *  updateGroupMembers($groupid,$openid) 移动用户分组  \r\n *  sendCustomMessage($data) 发送客服消息  \r\n *  getOauthRedirect($callback,$state,$scope) 获取网页授权oAuth跳转地址  \r\n *  getOauthAccessToken() 通过回调的code获取网页授权access_token  \r\n *  getOauthRefreshToken($refresh_token) 通过refresh_token对access_token续期  \r\n *  getOauthUserinfo($access_token,$openid) 通过网页授权的access_token获取用户资料  \r\n *  getSignature($arrdata,'sha1') 生成签名字串  \r\n *  generateNonceStr($length) 获取随机字串  \r\n *  createPackage($out_trade_no,$body,$total_fee,$notify_url,$spbill_create_ip,$fee_type=1,$bank_type=\"WX\",$input_charset=\"UTF-8\",$time_start=\"\",$time_expire=\"\",$transport_fee=\"\",$product_fee=\"\",$goods_tag=\"\",$attach=\"\") 生成订单package字符串  \r\n *  getPaySign($package, $timeStamp, $nonceStr) 支付签名(paySign)生成方法  \r\n *  checkOrderSignature($orderxml='') 回调通知签名验证  \r\n *  sendPayDeliverNotify($openid,$transid,$out_trade_no,$status=1,$msg='ok') 发货通知  \r\n *  getPayOrder($out_trade_no) 查询订单信息  \r\n *  getAddrSign($url, $timeStamp, $nonceStr, $user_token='') 获取收货地址JS的签名  \r\n \r\n  \r\n2. wechatext.class.php  \r\n非官方扩展API，需要配置公众平台账户和密码，能实现对已关注用户的点对点微信，此方式不保证长期有效。  \r\n类方法里提及的用户id在接口返回结构里表述为FakeId, 属同一概念, 在下面wechatauth类里则表示为Uin, 用户id对应的微信号必须通过getInfo()方法通过返回数组的Username值获取, 但非关注关系用户资料不能获取.  \r\n调用下列方法前必须经过login()方法和checkValid()验证方法才能获得调用权限. 有的账户无法通过登陆可能因为要求提供验证码, 可以手动登陆后把获取到的cookie写进程序存放cookie的文件解决.  \r\n程序使用了经过修改的snoopy兼容式HTTP类方法, 在类似BAE/SAE云服务器上可能不能正常运行, 因为云服务的curl方法是经过重写的, 某些header参数如网站来源参数不被支持.  \r\n类主要方法:\r\n *  send($id,$content) 向某用户id发送微信文字信息 \r\n *  sendNews($id,$msgid) 发送图文消息, 可通过getNewsList获取$msgid\r\n *  getUserList($page,$pagesize,$groupid) 获取用户信息\r\n *  getGroupList($page,$pagesize) 获取群组信息\r\n *  getNewsList($page,$pagesize) 获取图文信息列表 \r\n *  uploadFile($filepath,$type) 上传附件,包括图片/音频/视频\r\n *  getFileList($type,$page,$pagesize) 获取素材库文件列表\r\n *  sendImage($id,$fid) 发送图片消息\r\n *  sendAudio($id,$fid) 发送音频消息\r\n *  sendVideo($id,$fid) 发送视频消息 \r\n *  getInfo($id) 根据id获取用户资料,注: 非关注关系用户资料不能获取  \r\n *  getNewMsgNum($lastid) 获取从$lastid算起新消息的数目  \r\n *  getTopMsg() 获取最新一条消息的数据, 此方法获取的消息id可以作为检测新消息的$lastid依据  \r\n *  getMsg($lastid,$offset=0,$perpage=50,$day=0,$today=0,$star=0) 获取最新的消息列表, 列表将返回消息id, 用户id, 消息类型, 文字消息等参数  \r\n *  消息返回结构:  {\"id\":\"消息id\",\"type\":\"类型号(1为文字,2为图片,3为语音)\",\"fileId\":\"0\",\"hasReply\":\"0\",\"fakeId\":\"用户uid\",\"nickName\":\"昵称\",\"dateTime\":\"时间戳\",\"content\":\"文字内容\"}   \r\n *  getMsgImage($msgid,$mode='large') 若消息type类型为2, 调用此方法获取图片数据  \r\n *  getMsgVoice($msgid) 若消息type类型为3, 调用此方法获取语音数据  \r\n\r\n3. wechatauth.class.php  \r\n通过微信二维码登陆微信的API, 能实现第三方网站同步登陆, 首先程序分别通过get_login_code和get_code_image方法获取授权二维码图片, 然后利用微信手机客户端扫描二维码图片后将自动跳出授权页面, 用户点击授权后即可获取对应的用户资料和头像信息. 详细验证步骤请看test3.php例子.   \r\n类主要方法:\r\n *  get_login_code() 获取登陆授权码, 通过授权码才能获取二维码  \r\n *  get_code_image($code='') 将上面获取的授权码转换为图片二维码  \r\n *  verify_code() 鉴定是否登陆成功,返回200为最终授权成功.  \r\n *  get_login_cookie() 鉴定成功后调用此方法即可获取用户基本信息  \r\n *  sendNews($account,$title,$summary,$content,$pic,$srcurl='') 向一个微信账户发送图文信息  \r\n *  get_avatar($url) 获取用户头像图片数据  \r\n *  logout() 注销登陆  \r\n\r\n4. wechat.js\r\n微信内嵌网页特殊功能js调用：\r\n * WeixinJS.hideOptionMenu() 隐藏右上角按钮\r\n * WeixinJS.hideToolbar() 隐藏工具栏\r\n * 通过定义全局变量dataForWeixin配置触发分享的内容：\r\n ```javascript\r\n var dataForWeixin={\r\n\t   appId:\"\",\r\n\t   MsgImg:\"消息图片路径\",\r\n\t   TLImg:\"时间线图路径\",\r\n\t   url:\"分享url路径\",\r\n\t   title:\"标题\",\r\n\t   desc:\"描述\",\r\n\t   fakeid:\"\",\r\n\t   callback:function(){}\r\n\t};\r\n ```\r\n \r\n\r\n官方Wechat调用示例：\r\n--------  \r\n```php\r\n//test1.php\r\ninclude \"wechat.class.php\";\r\n$options = array(\r\n\t\t'token'=>'tokenaccesskey' //填写你设定的key\r\n\t);\r\n$weObj = new Wechat($options);\r\n$weObj->valid(); //注意, 应用验证通过后,可将此句注释掉, 但会降低网站安全性\r\n$type = $weObj->getRev()->getRevType();\r\nswitch($type) {\r\n\tcase Wechat::MSGTYPE_TEXT:\r\n\t\t\t$weObj->text(\"hello, I'm wechat\")->reply();\r\n\t\t\texit;\r\n\t\t\tbreak;\r\n\tcase Wechat::MSGTYPE_EVENT:\r\n\t\t\tbreak;\r\n\tcase Wechat::MSGTYPE_IMAGE:\r\n\t\t\tbreak;\r\n\tdefault:\r\n\t\t\t$weObj->text(\"help info\")->reply();\r\n}\r\n```\r\n\r\n扩展包Wechatext调用示例: \r\n--------\r\n```php\r\n//test2.php \r\n\tinclude \"wechatext.class.php\";\r\n\t\r\n\tfunction logdebug($text){\r\n\t\tfile_put_contents('./data/log.txt',$text.\"\\n\",FILE_APPEND);\t\t\r\n\t};\r\n\t\r\n\t$options = array(\r\n\t\t'account'=>'demo@domain.com',\r\n\t\t'password'=>'demo',\r\n\t\t'datapath'=>'./data/cookie_',\r\n\t\t\t'debug'=>true,\r\n\t\t\t'logcallback'=>'logdebug'\t\r\n\t); \r\n\t$wechat = new Wechatext($options);\r\n\tif ($wechat->checkValid()) {\r\n\t\t// 获取用户信息\r\n\t\t$data = $wechat->getInfo('3974255');\r\n\t\tvar_dump($data);\r\n\t\t// 获取最新一条消息\r\n\t\t$topmsg = $wechat->getTopMsg();\r\n\t\tvar_dump($topmsg);\r\n\t\t// 主动回复消息\r\n\t\tif ($topmsg && $topmsg['has_reply']==0)\r\n\t\t$wechat->send($topmsg['fakeid'],'hi '.$topmsg['nick_name'].',rev:'.$topmsg['content']);\t\r\n\t}\r\n```\r\n\r\n微信二维码Wechatauth登陆示例: \r\n-------- \r\n```php\r\n//test3.php\r\n\tinclude \"../wechatauth.class.php\";\r\n\tsession_start();\r\n\t$sid  = session_id();\r\n\t$options = array(\r\n\t\t'account'=>$sid,\r\n\t\t'datapath'=>'../data/cookiecode_',\r\n\t); \r\n\t$wechat = new Wechatauth($options);\r\n\t\r\n\tif (isset($_POST['code'])) {\r\n\t\t$logincode = $_POST['code'];\r\n\t\t$vres = $wechat->set_login_code($logincode)->verify_code();\r\n\t\tif ($vres===false) {\r\n\t\t\t$result = array('status'=>0);\r\n\t\t} else {\r\n\t\t\t$result = array('status'=>$vres);\r\n\t\t\tif ($vres==200) {\r\n\t\t\t\t$result['info'] = $wechat->get_login_info();\r\n\t\t\t\t$result['cookie'] = $wechat->get_login_cookie(true);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tdie(json_encode($result));\t\r\n\t}\r\n\t$logincode =  $wechat->get_login_code(); //获取授权码\r\n\t$qrimg = $wechat->get_code_image(); //待输出的二维码图片\r\n```\r\nHTML部分请看test/test3.php, 主要是定时ajax查询是否已经授权成功\r\n\r\n####Change Log\r\n-------- \r\n2014.04.19\r\n* 新增cache接口，用户缓存access_token等信息\r\n* 新增Wechat::uploadArticle($articles)上传图文素材\r\n* 新增Wechat::massSendByGroup($media_id, $group_id)根据分组ID群发消息\r\n* 新增Wechat::massSendByOpenId($media_id, $openid_list)根据用户OPENID群发消息\r\n* 新增Wechat::massDelete($msg_id)删除群发消息\r\n* 引入php_fast_cace.php作为cache类库\r\n* 增加菜单相关示例\r\n* 增加二维码相关示例\r\n* 增加用户相关示例\r\n\r\n2014.04.21\r\n* 修改```http_post```方法，增加```$is_upload```方法，是否为上传文件\r\n* 新增Wechat::uploadMedia($media_source, $type)上传多媒体文件[文档](http://mp.weixin.qq.com/wiki/index.php?title=%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E5%A4%9A%E5%AA%92%E4%BD%93%E6%96%87%E4%BB%B6)\r\n* 增加高级群发接口测试文件\r\n* 修改群发相关BUG\r\n* 新增帮助文件```wechat.helper.php```\r\n\r\n2014.04.23\r\n* 增加Wechat::getUserGroup($openid) 根据用户的openid获取用户所在分组\r\n\r\n\r\nLicense\r\n-------\r\nThis is licensed under the GNU LGPL, version 2.1 or later.   \r\nFor details, see: http://creativecommons.org/licenses/LGPL/2.1/\r\n\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}